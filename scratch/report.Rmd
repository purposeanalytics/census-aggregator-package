---
output: html_document
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE,
  out.width = "100%", fig.height = 2.25
)
```

```{css}
.section-heading {
  background-color: lightgrey;
  padding-left: 5px;
}

.box {
  height: 100px;
  background-color: lightgrey;
  text-align: center;
  padding: 10px;
  margin-right: 2px;
}

.box-last {
  margin-right: 0;
  margin-left: 2px;
}
```


```{r packages}
library(dplyr)
library(censusaggregate)
library(purrr)
library(scales)
library(knitr)
library(kableExtra)
library(tidyr)
library(stringr)
```

```{r data}
regions <- list(CSD = c("3520005", "3521005", "3521010"))
level <- "CSD"

vectors <- tibble::tribble(
    ~vector, ~vector_label, ~vector_label_short,
    "v_CA16_401", "Population, 2016", "population_2016",
    "v_CA16_402", "Population, 2011", "population_2011",
    "v_CA16_407", "Land area in square kilometres", "area",
    "v_CA16_1", "Total - Age", "age",
    "v_CA16_418", "Private households by household size", "household_size",
    "v_CA16_484", "Total number of census families in private households - 100% data", "family_type",
    "v_CA16_504", "Total - Private households by household type - 100% data", "household_type",
    "v_CA16_512", "Total - Knowledge of official languages for the total population excluding institutional residents - 100% data", "knowledge_of_english",
    "v_CA16_1355", "Total - Language spoken most often at home for the total population excluding institutional residents - 100% data", "top_10_languages",
    "v_CA16_2525", "In low income based on the Low-income measure, after tax (LIM-AT)", "lim_at",
    "v_CA16_3405", "Total - Immigrant status and period of immigration for the population in private households - 25% sample data", "immigrant_status",
    "v_CA16_3852", "Total - Aboriginal identity for the population in private households - 25% sample data", "aboriginal_identity",
    "v_CA16_3954", "Total - Visible minority for the population in private households - 25% sample data", "visible_minority",
    "v_CA16_3999", "Total - Ethnic origin for the population in private households - 25% sample data", "ethnic_origin",
    "v_CA16_4836", "Total - Private households by tenure - 25% sample data", "household_tenure",
    "v_CA16_4886", "Total -  Owner and tenant households with household total income greater than zero, in non-farm, non-reserve private dwellings by shelter-cost-to-income ratio - 25% sample data", "unaffordable_housing",
    "v_CA16_5051", "Total - Highest certificate, diploma or degree for the population aged 15 years and over in private households - 25% sample data", "educational_attainment"
  )

# Get data for vectors and children ----

data <- get_census_vectors_and_children(
  regions = regions,
  level = level,
  vectors = vectors[["vector"]],
  quiet = TRUE
)
```

```{r data_export}
# Prep data for export
# Choose which vectors to keep within each

breakdown_vectors <- list(
  "v_CA16_401" = NA,
  "v_CA16_418" = c("v_CA16_419", "v_CA16_420", "v_CA16_421", "v_CA16_422", "v_CA16_423"),
  "v_CA16_3954" = c(
    "v_CA16_3957", "v_CA16_3960", "v_CA16_3963", "v_CA16_3966",
    "v_CA16_3969", "v_CA16_3972", "v_CA16_3975", "v_CA16_3978", "v_CA16_3981",
    "v_CA16_3984", "v_CA16_3987", "v_CA16_3990", "v_CA16_3993",
    "v_CA16_3996"
  ),
  "v_CA16_4836" = c("v_CA16_4837", "v_CA16_4838", "v_CA16_4839"),
  "v_CA16_4886" = "v_CA16_4888",
  "v_CA16_1" = c(
    # 5 year breakdown
    "v_CA16_7", "v_CA16_25", "v_CA16_43", "v_CA16_64", "v_CA16_82",
    "v_CA16_100", "v_CA16_118", "v_CA16_136", "v_CA16_154", "v_CA16_172",
    "v_CA16_190", "v_CA16_208", "v_CA16_226", "v_CA16_247", "v_CA16_265",
    "v_CA16_283", "v_CA16_301", "v_CA16_322", "v_CA16_340", "v_CA16_358", "v_CA16_376"
  ),
  "v_CA16_512" = c("v_CA16_515", "v_CA16_521"),
  "v_CA16_3405" = c("v_CA16_3411", "v_CA16_3432"),
  "v_CA16_3852" = c("v_CA16_3855"),
  "v_CA16_5051" = c("v_CA16_5054", "v_CA16_5057", "v_CA16_5060"),
  "v_CA16_484" = c("v_CA16_485", "v_CA16_488", "v_CA16_489"),
  "v_CA16_504" = c("v_CA16_505", "v_CA16_508", "v_CA16_509")
)

filter_breakdown_vectors <- function(data, vector) {
  vector_breakdown_vectors <- breakdown_vectors[[vector]]

  if (!all(is.na(vector_breakdown_vectors))) {
    data <- data %>%
      filter(
        vector %in% c(vector_breakdown_vectors, !!vector)
      )
  } else {
    data <- data %>%
      filter(
        vector == !!vector
      )
  }

  data
}

# Aggregate vectors - treat v_CA16_407 (land area) separately, since it will be used for population density, and v_CA16_402 (population 2011) separately, since it will be used for population change

vectors <- vectors %>%
  filter(!(vector %in% c("v_CA16_407", "v_CA16_402")))

data_breakdown <- map_dfr(
  vectors[["vector"]],
  function(vector) {
    data %>%
      filter_breakdown_vectors(vector) %>%
      aggregate_census_vectors()
  }
) %>%
  select(highest_parent_vector, vector, label, value, value_proportion) %>%
  distinct() %>%
  left_join(vectors, by = c("highest_parent_vector" = "vector")) %>%
  select(highest_parent_vector, vector, vector_label_short, label, value, value_proportion)
```

::: {.section-heading}

## Snapshot

:::

::::: {.row}

```{r snapshot}
# Number of geographies (CSDs/CTs), population, number of households, population change (2011 to 2016), population density

areas_selected <- glue::glue("{n} {geography}{s}",
  n = length(unlist(regions)),
  geography = case_when(
    level == "CSD" ~ "Census subdivision",
    level == "CT" ~ "Census tract"
  ),
  s = ifelse(n > 1, "s", "")
)

population <- data_breakdown %>%
  filter(vector_label_short == "population_2016") %>%
  pull(value) %>%
  comma()

households <- data %>%
  select(geo_uid, households) %>%
  distinct() %>%
  summarise(across(households, sum, na.rm = TRUE)) %>%
  pull(households) %>%
  comma()

population_change <- data %>%
  aggregate_population_change() %>%
  pull(value) %>%
  percent(accuracy = 0.1)

population_density <- data %>%
  filter(label %in% c("Population, 2016", "Land area in square kilometres")) %>%
  aggregate_population_density() %>%
  pull(value) %>%
  comma()

population_density <- glue::glue("{population_density} people per km^2")
#
# summary_statistics <- tribble(
#   ~field, ~value,
#   "Areas selected", areas_selected,
#   "Population", population,
#   "Households", households,
#   "Population change (2011 to 2016)", population_change,
#   "Population density", population_density
# ) %>%
#   mutate(field = glue::glue("{field}:"))
#
# kable(summary_statistics, align = "lr", col.names = c("", "")) %>%
#   kableExtra::column_spec(column = 1, bold = TRUE)
```

:::: {.col-sm-3}

::: {.box}

#### Population

`r population`

:::

::::

:::: {.col-sm-3}

::: {.box}

#### Population change

`r population_change`

:::

::::

:::: {.col-sm-3}

::: {.box}

#### Population density

`r population_density`

:::

::::

:::: {.col-sm-3}

::: {.box .box-last}

#### Households

`r households`

:::

::::

:::::

::: {.section-heading}

## Population by age cohorts

:::

:::: {.row}

::: {.col-sm-8}

```{r age, fig.height = 2.25}
# Breakdowns:
# 0-14; 15-24; 25-44; 45-64; 65-84, 85+

age_vectors <- cancensus::child_census_vectors("v_CA16_1", keep_parent = TRUE) %>%
  filter(str_detect(label, "to") | str_detect(label, "and over"), units == "Number") %>%
  mutate(label_derived = str_replace(label, "years and over", "to NA years")) %>%
  separate(label_derived, into = c("min", "max"), sep = " to ", convert = TRUE) %>%
  mutate(
    max = str_remove(max, " years"), max = as.numeric(max),
    gap = max - min,
    group = case_when(
      min == 0 & max == 14 ~ "0 to 14",
      min >= 15 & max <= 24 & gap == 4 ~ "15 to 24",
      min >= 25 & max <= 44 & gap == 4 ~ "25 to 44",
      min >= 45 & max <= 64 & gap == 4 ~ "45 to 65",
      min >= 65 & max <= 84 & gap == 4 ~ "65 to 84",
      min == 85 & is.na(max) ~ "85+"
    )
  ) %>%
  filter(!is.na(group)) %>%
  select(vector, group)

age_vectors_data <- get_census_vectors_and_children(
  regions = regions,
  level = level,
  vectors = c("v_CA16_1", age_vectors[["vector"]]),
  quiet = TRUE
)

age_cohorts <- age_vectors_data %>%
  filter(vector %in% c("v_CA16_1", age_vectors[["vector"]])) %>%
  left_join(age_vectors, by = "vector") %>%
  mutate(
    vector_new = group, label = group, details = group, highest_parent_vector = "v_CA16_1",
    vector = coalesce(vector_new, vector)
  ) %>%
  aggregate_census_vectors() %>%
  filter(vector != highest_parent_vector)

age_cohorts %>%
  plot_census_vector()
```

:::

::: {.col-sm-4}

```{r}
age_cohorts %>%
  table_census_vector()
```

:::

::::

::: {.section-heading}

## Households, families, education, and language

:::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Private households by size

:::

```{r household_size}
household_size <- data_breakdown %>%
  filter(
    vector_label_short == "household_size",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

household_size %>%
  plot_census_vector()

household_size %>%
  table_census_vector()
```

::::

:::: {.col-sm-6}

::: {.section-heading}

### Family type

:::

```{r family_type}
family_type <- data_breakdown %>%
  filter(
    vector_label_short == "family_type",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

family_type %>%
  plot_census_vector()

family_type %>%
  table_census_vector()
```

::::

:::::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Multiple family households

:::

```{r household_type}
multiple_family_households <- data_breakdown %>%
  filter(
    vector_label_short == "household_type",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

multiple_family_households %>%
  plot_census_vector()

multiple_family_households %>%
  table_census_vector()
```

::::

:::: {.col-sm-6}

::: {.section-heading}

### Educational attainment

:::

```{r educational_attainment}
educational_attainment <- data_breakdown %>%
  filter(
    vector_label_short == "educational_attainment",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

educational_attainment %>%
  plot_census_vector()

educational_attainment %>%
  table_census_vector()
```

::::

:::::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Knowledge of English

:::

```{r knowledge_of_english}
knowledge_of_english <- data_breakdown %>%
  filter(
    vector_label_short == "knowledge_of_english",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order()

knowledge_of_english %>%
  plot_census_vector()

knowledge_of_english %>%
  table_census_vector
```

::::

:::: {.col-sm-6}

::: {.section-heading}

### Language spoken at home

:::

::::

:::::

::: {.section-heading}

## Income and housing

:::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Household income

:::

::::

:::: {.col-sm-6}

::: {.section-heading}

### Low income

:::


```{r lim_at}
# TODO - needs to be divided by population

data_breakdown %>%
  filter(vector_label_short == "lim_at")
```

::::

:::::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Household tenure

:::

```{r household_tenure}
data_breakdown %>%
  filter(
    vector_label_short == "household_tenure",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order() %>%
  plot_census_vector()
```

::::

:::: {.col-sm-6}

::: {.section-heading}

### Shelter cost

:::

```{r unaffordable_housing}
data_breakdown %>%
  filter(vector_label_short == "unaffordable_housing")
```

::::

:::::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Unaffordable housing

:::

::::

:::::

::: {.section-heading}

## Diversity and immigration

:::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Immigrant status

:::

```{r immigrant_status}
data_breakdown %>%
  filter(
    vector_label_short == "immigrant_status",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order() %>%
  plot_census_vector()
```

::::

:::: {.col-sm-6}

::: {.section-heading}

### Aboriginal identity

:::

```{r aboriginal_identity}
data_breakdown %>%
  filter(
    vector_label_short == "aboriginal_identity",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order() %>%
  plot_census_vector()
```

::::

:::::

::::: {.row}

:::: {.col-sm-6}

::: {.section-heading}

### Country of origin

:::

::::

:::: {.col-sm-6}

::: {.section-heading}

### Visible minority population

:::

```{r visible_minority}
data_breakdown %>%
  filter(
    vector_label_short == "visible_minority",
    vector != highest_parent_vector
  ) %>%
  derive_census_vector_order(TRUE) %>%
  plot_census_vector()
```

::::

:::::
